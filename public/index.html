<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatDash - Statistical Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            /* Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #1e293b;
            --bg-secondary: #334155;
            --bg-tertiary: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-content-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-content-btn:hover {
            background-color: var(--accent-hover);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 24px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .structure-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }

        .structure-item:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .structure-item.active {
            background-color: var(--accent-color);
            color: white;
        }

        .structure-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .structure-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .structure-count {
            background-color: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .structure-item.active .structure-count {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .theme-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background-color: var(--accent-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: 60px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .breadcrumb i {
            color: var(--text-muted);
        }

        .current-page {
            color: var(--text-primary);
            font-weight: 600;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-btn {
            padding: 8px 12px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .action-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .refresh-btn {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .refresh-btn:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        /* Dashboard Content */
        .dashboard-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .welcome-screen {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .welcome-icon {
            font-size: 64px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            font-size: 16px;
            margin-bottom: 32px;
        }

        .structure-dashboard {
            display: none;
        }

        .structure-dashboard.active {
            display: block;
        }

        .general-dashboard {
            display: block;
        }

        .general-dashboard.hidden {
            display: none;
        }

        .structures-overview {
            margin-top: 32px;
        }

        .section-header {
            margin-bottom: 24px;
            text-align: center;
        }

        .section-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .structures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        .structure-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--card-shadow);
        }

        .structure-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .structure-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .structure-card-icon {
            width: 40px;
            height: 40px;
            background-color: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .structure-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .structure-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .structure-stat {
            text-align: center;
        }

        .structure-stat-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 4px;
        }

        .structure-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-header {
            margin-bottom: 32px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading i {
            font-size: 24px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 1000;
                height: 100vh;
            }

            .sidebar.open {
                left: 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Property Selection */
        .section-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
        }

        .property-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .property-item {
            background-color: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .property-item:hover {
            border-color: var(--accent-color);
            background-color: var(--bg-primary);
        }

        .property-item.selected {
            border-color: var(--accent-color);
            background-color: var(--accent-color);
            color: white;
        }

        .property-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .property-item.selected .property-checkbox {
            background-color: white;
            border-color: white;
            color: var(--accent-color);
        }

        .property-info {
            flex: 1;
        }

        .property-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .property-type {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-item.selected .property-type {
            color: rgba(255, 255, 255, 0.8);
        }

        .property-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .property-item.selected .property-description {
            color: rgba(255, 255, 255, 0.9);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .select-all-btn {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .select-all-btn:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .clear-all-btn {
            background-color: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .clear-all-btn:hover {
            background-color: #d97706;
            border-color: #d97706;
        }

        .primary-btn {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: 600;
        }

        .primary-btn:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .primary-btn:disabled {
            background-color: var(--text-muted);
            border-color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Statistics Results */
        .statistics-results {
            margin-top: 24px;
        }

        .statistics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        /* Relationships */
        .relationships-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .relationship-item {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .relationship-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .relationship-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .relationship-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .relationship-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .relationship-type {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .relationship-details {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Property Type Icons */
        .property-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }

        .type-text { background-color: #3b82f6; }
        .type-number { background-color: #10b981; }
        .type-date { background-color: #f59e0b; }
        .type-select { background-color: #8b5cf6; }
        .type-object { background-color: #ef4444; }
        .type-boolean { background-color: #06b6d4; }
        .type-url { background-color: #84cc16; }
        .type-email { background-color: #ec4899; }
        .type-phone { background-color: #f97316; }
        .type-file { background-color: #6b7280; }
        .type-unknown { background-color: var(--text-muted); }

        /* Diagram Container */
        .diagram-container {
            min-height: 400px;
            background-color: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .diagram-structure {
            position: absolute;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            min-width: 180px;
            box-shadow: var(--card-shadow);
            cursor: move;
        }

        .diagram-structure.main {
            border-color: var(--accent-color);
            border-width: 3px;
        }

        .diagram-structure-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .diagram-structure-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .diagram-structure-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .diagram-property {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 0;
            font-size: 12px;
        }

        .diagram-property-icon {
            width: 12px;
            text-align: center;
            color: var(--text-muted);
        }

        .diagram-property.primary-key {
            font-weight: 600;
            color: var(--accent-color);
        }

        .diagram-property.foreign-key {
            color: var(--warning-color);
        }

        .diagram-relationship {
            position: absolute;
            pointer-events: none;
        }

        .diagram-relationship-line {
            stroke: var(--accent-color);
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .diagram-relationship-label {
            font-size: 11px;
            fill: var(--text-secondary);
            text-anchor: middle;
        }

        /* Statistics Builder */
        .stats-builder {
            margin-bottom: 24px;
        }

        .builder-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .builder-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .builder-field label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-chart-result {
            margin-top: 24px;
            padding: 20px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* Single Value Card */
        .single-value-card {
            text-align: center;
            padding: 32px;
            background: linear-gradient(135deg, var(--accent-color), #8b5cf6);
            color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .single-value-number {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .single-value-label {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .single-value-change {
            font-size: 14px;
            opacity: 0.8;
        }

        .change-positive {
            color: #10b981;
        }

        .change-negative {
            color: #ef4444;
        }

        /* Progress Bar */
        .progress-card {
            padding: 24px;
            text-align: center;
        }

        .progress-header {
            margin-bottom: 20px;
        }

        .progress-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .progress-values {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-success { background-color: var(--success-color); }
        .progress-warning { background-color: var(--warning-color); }
        .progress-danger { background-color: var(--error-color); }

        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            margin-top: 12px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .builder-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">
                    <i class="fas fa-chart-line"></i>
                    StatDash
                </div>
                <button type="button" class="new-content-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>

            <div class="sidebar-content">
                <div class="section-title">Available Structures</div>
                <div id="structuresList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div>Loading structures...</div>
                    </div>
                </div>
            </div>

            <div class="theme-toggle">
                <span class="theme-label">Dark Mode</span>
                <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="breadcrumb">
                    <i class="fas fa-home"></i>
                    <span id="currentPage" class="current-page">Dashboard</span>
                </div>
                <div class="top-actions">
                    <button type="button" class="action-btn" onclick="showWelcome()">
                        <i class="fas fa-home"></i>
                        Home
                    </button>
                    <button type="button" class="action-btn refresh-btn" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- General Dashboard -->
                <div id="generalDashboard" class="general-dashboard">
                    <div class="dashboard-header">
                        <div class="dashboard-title">Workspace Overview</div>
                        <div class="dashboard-subtitle">General statistics and analytics for your Capacities workspace</div>
                    </div>

                    <!-- Workspace Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStructures">-</div>
                            <div class="stat-label">Total Structures</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="workspaceTotalObjects">-</div>
                            <div class="stat-label">Total Objects</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="workspaceTotalCollections">-</div>
                            <div class="stat-label">Collections</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="workspaceLastUpdated">-</div>
                            <div class="stat-label">Last Updated</div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                Structures Distribution
                            </div>
                            <div class="chart-container">
                                <canvas id="structuresChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Top Structures
                            </div>
                            <div class="chart-container">
                                <canvas id="topStructuresChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Structures List -->
                    <div class="structures-overview">
                        <div class="section-header">
                            <h3><i class="fas fa-sitemap"></i> All Structures</h3>
                            <p>Click on any structure to view detailed analytics</p>
                        </div>
                        <div class="structures-grid" id="structuresOverview">
                            <!-- Structures will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Structure Dashboard -->
                <div id="structureDashboard" class="structure-dashboard">
                    <div class="dashboard-header">
                        <div class="dashboard-title" id="structureTitle">Nome da Estrutura</div>
                        <div class="dashboard-subtitle" id="structureSubtitle">Configure properties for statistical analysis</div>
                    </div>

                    <!-- Structure Information -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalProperties">-</div>
                            <div class="stat-label">Total Properties</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalRelationships">-</div>
                            <div class="stat-label">Relationships</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCollections">-</div>
                            <div class="stat-label">Collections</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="selectedPropertiesCount">0</div>
                            <div class="stat-label">Selected Properties</div>
                        </div>
                    </div>

                    <!-- Property Selection -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-sliders-h"></i> Property Selection</h3>
                            <p>Select properties to generate detailed statistics and visualizations</p>
                        </div>
                        <div id="propertySelection" class="property-selection">
                            <!-- Properties will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="action-btn select-all-btn" onclick="selectAllProperties()">
                                <i class="fas fa-check-square"></i>
                                Select All
                            </button>
                            <button type="button" class="action-btn clear-all-btn" onclick="clearAllProperties()">
                                <i class="fas fa-square"></i>
                                Clear All
                            </button>
                            <button type="button" class="action-btn primary-btn" onclick="generateStatistics()" id="generateStatsBtn">
                                <i class="fas fa-chart-bar"></i>
                                Generate Statistics
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Results -->
                    <div id="statisticsResults" class="statistics-results" style="display: none;">
                        <div class="section-header">
                            <h3><i class="fas fa-chart-line"></i> Statistics Results</h3>
                            <p>Detailed analysis of selected properties</p>
                        </div>
                        <div id="statisticsCharts" class="charts-grid">
                            <!-- Dynamic charts will be generated here -->
                        </div>
                    </div>

                    <!-- Relationship Diagram -->
                    <div id="relationshipDiagramSection" class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-sitemap"></i> Relationship Diagram</h3>
                            <p>Visual representation of relationships between structures (MySQL style)</p>
                        </div>
                        <div id="relationshipDiagram" class="diagram-container">
                            <!-- Diagram will be rendered here -->
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="action-btn primary-btn" onclick="loadRelationshipDiagram()">
                                <i class="fas fa-sitemap"></i>
                                Load Diagram
                            </button>
                        </div>
                    </div>

                    <!-- Custom Statistics Builder -->
                    <div id="customStatsSection" class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-chart-bar"></i> Custom Statistics Builder</h3>
                            <p>Create custom charts and statistics by selecting properties and chart types</p>
                        </div>
                        
                        <div class="stats-builder">
                            <div class="builder-row">
                                <div class="builder-field">
                                    <label>Chart Type:</label>
                                    <select id="chartTypeSelect" class="form-select">
                                        <option value="single-value">Single Value Card</option>
                                        <option value="progress">Progress Bar</option>
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="scatter">Scatter Plot</option>
                                    </select>
                                </div>
                                
                                <div class="builder-field">
                                    <label>Property (X-Axis):</label>
                                    <select id="xAxisSelect" class="form-select">
                                        <option value="">Select Property</option>
                                    </select>
                                </div>
                                
                                <div class="builder-field" id="yAxisField">
                                    <label>Property (Y-Axis):</label>
                                    <select id="yAxisSelect" class="form-select">
                                        <option value="">Select Property</option>
                                    </select>
                                </div>
                                
                                <div class="builder-field">
                                    <label>Aggregation:</label>
                                    <select id="aggregationSelect" class="form-select">
                                        <option value="count">Count</option>
                                        <option value="sum">Sum</option>
                                        <option value="average">Average</option>
                                        <option value="min">Minimum</option>
                                        <option value="max">Maximum</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="button" class="action-btn primary-btn" onclick="generateCustomChart()" id="generateCustomBtn">
                                    <i class="fas fa-chart-line"></i>
                                    Generate Chart
                                </button>
                            </div>
                        </div>
                        
                        <div id="customChartResult" class="custom-chart-result" style="display: none;">
                            <!-- Custom chart will be rendered here -->
                        </div>
                    </div>

                    <!-- Relationships -->
                    <div id="relationshipsSection" class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-project-diagram"></i> Structure Relationships</h3>
                            <p>Connections with other structures in your workspace</p>
                        </div>
                        <div id="relationshipsContainer" class="relationships-list">
                            <!-- Relationships will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let currentStructure = null;
        let currentStructureData = null;
        let selectedProperties = new Set();
        let isDarkMode = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing app...');
            initializeApp();
        });

        async function initializeApp() {
            try {
                console.log('üîß Initializing app...');
                loadSavedTheme();
                await loadStructures();
                console.log('‚úÖ App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Error initializing application');
            }
        }

        // Theme Management
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeToggle();
        }

        function updateThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            const label = document.querySelector('.theme-label');
            
            if (isDarkMode) {
                toggle.classList.add('active');
                label.textContent = 'Light Mode';
            } else {
                toggle.classList.remove('active');
                label.textContent = 'Dark Mode';
            }
        }

        // Load saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            updateThemeToggle();
        }

        // Load structures
        async function loadStructures() {
            try {
                console.log('üîÑ Loading structures...');
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                
                console.log('üìä Received data:', data);
                console.log('üîç Data type:', typeof data);
                console.log('üîç Data keys:', Object.keys(data));
                
                if (data.success) {
                    currentData = data;
                    console.log('üèóÔ∏è Full data structure:', data);
                    console.log('üèóÔ∏è Structures data:', data.structures);
                    console.log('üèóÔ∏è Data.data:', data.data);
                    
                    if (data.data && data.data.space && data.data.space.structures) {
                        // Usar dados do espa√ßo (formato correto)
                        console.log('üîÑ Found structures in data.data.space.structures');
                        const structuresObject = data.data.space.structures;
                        
                        populateStructuresList(structuresObject);
                        populateGeneralDashboard(data.data.space);
                        createGeneralCharts(structuresObject);
                    } else if (data.structures && Array.isArray(data.structures)) {
                        // Fallback para formato antigo
                        console.log('üîÑ Found structures in data.structures (legacy format)');
                        const structuresArray = data.structures;
                        const structuresObject = {};
                        
                        structuresArray.forEach(structure => {
                            structuresObject[structure.id] = {
                                ...structure,
                                name: structure.title || structure.name || structure.id,
                                count: structure.count || structure.objectCount || 0
                            };
                        });
                        
                        console.log('üîÑ Converted structures to object format:', structuresObject);
                        
                        populateStructuresList(structuresObject);
                        populateGeneralDashboard({ structures: structuresObject });
                        createGeneralCharts(structuresObject);
                    } else {
                        console.error('‚ùå No structures data found in response');
                        console.error('‚ùå Available keys:', Object.keys(data));
                        showError('No structures data available');
                    }
                } else {
                    throw new Error(data.error || 'Error loading data');
                }
            } catch (error) {
                console.error('Error loading structures:', error);
                showError('Error loading structures: ' + error.message);
            }
        }

        function populateStructuresList(structures) {
            const container = document.getElementById('structuresList');
            
            console.log('üîç Populating structures list with:', structures);
            
            if (!structures || Object.keys(structures).length === 0) {
                console.log('‚ö†Ô∏è No structures data available');
                container.innerHTML = '<div class="loading">No structures available</div>';
                return;
            }

            const structuresList = Object.entries(structures)
                .map(([id, structure]) => {
                    const displayName = structure.title || structure.name || structure.id;
                    const icon = getStructureIcon(structure.id);
                    // Usar a contagem real de objetos da estrutura
                    const count = structure.count || structure.objectCount || 0;
                    
                    console.log(`üìã Structure: ${id} -> ${displayName} (count: ${count})`);
                    
                    return `
                        <div class="structure-item" onclick="selectStructure('${id}')" data-id="${id}">
                            <i class="${icon}"></i>
                            <span class="structure-name">${displayName}</span>
                            <span class="structure-count">${count}</span>
                        </div>
                    `;
                })
                .join('');

            console.log(`‚úÖ Populated ${Object.keys(structures).length} structures`);
            container.innerHTML = structuresList;
        }

        function populateGeneralDashboard(space) {
            console.log('üè† Populating general dashboard with:', space);
            
            // Update workspace stats
            document.getElementById('totalStructures').textContent = space.totalStructures || space.structures?.length || 0;
            document.getElementById('workspaceTotalObjects').textContent = space.totalObjects || 0;
            document.getElementById('workspaceTotalCollections').textContent = space.totalCollections || 0;
            document.getElementById('workspaceLastUpdated').textContent = 'Now';

            // Populate structures overview
            const container = document.getElementById('structuresOverview');
            
            // Check if structures is an object or array
            let structuresArray = [];
            if (space.structures) {
                if (Array.isArray(space.structures)) {
                    structuresArray = space.structures;
                } else if (typeof space.structures === 'object') {
                    // Convert object to array with enhanced data
                    structuresArray = Object.entries(space.structures).map(([id, structure]) => ({
                        id: id,
                        title: structure.name || structure.title || id,
                        name: structure.name || structure.title || id,
                        count: structure.count || structure.objectCount || 0,
                        type: structure.type || 'unknown',
                        propertyDefinitions: [], // Will be loaded when clicked
                        labelColor: structure.labelColor || 'blue',
                        properties: structure.properties || structure.propertyCount || 0
                    }));
                }
            }
            
            if (structuresArray.length === 0) {
                container.innerHTML = '<div class="loading">No structures available</div>';
                return;
            }

            const structuresCards = structuresArray
                .map(structure => {
                    const displayName = structure.title || structure.name || structure.id;
                    const icon = getStructureIcon(structure.id);
                    // Usar a contagem real de objetos
                    const count = structure.count || structure.objectCount || 0;
                    // Usar a contagem real de propriedades
                    const propertyCount = structure.properties || structure.propertyCount || 0;
                    
                    return `
                        <div class="structure-card" onclick="selectStructure('${structure.id}')">
                            <div class="structure-card-header">
                                <div class="structure-card-icon">
                                    <i class="${icon}"></i>
                                </div>
                                <div class="structure-card-title">${displayName}</div>
                            </div>
                            <div class="structure-card-stats">
                                <div class="structure-stat">
                                    <div class="structure-stat-number">${count}</div>
                                    <div class="structure-stat-label">Objects</div>
                                </div>
                                <div class="structure-stat">
                                    <div class="structure-stat-number">${propertyCount}</div>
                                    <div class="structure-stat-label">Properties</div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = structuresCards;
        }

        function getStructureIcon(structureId) {
            const iconMap = {
                'RootPage': 'fas fa-file-alt',
                'RootDatabase': 'fas fa-database',
                'MediaImage': 'fas fa-image',
                'MediaPDF': 'fas fa-file-pdf',
                'RootTag': 'fas fa-tag',
                'RootQuery': 'fas fa-search',
                'RootAIChat': 'fas fa-comments',
                'RootSimpleTable': 'fas fa-table',
                'RootDailyNote': 'fas fa-sticky-note',
                'MediaAudio': 'fas fa-music',
                'MediaVideo': 'fas fa-video',
                'MediaWebResource': 'fas fa-link',
                'MediaFile': 'fas fa-file',
                'd2801ef5-bb7b-4ba0-8da7-b0f55453059d': 'fas fa-user', // Pessoa
                '1fcab184-7c08-4b2e-8e6b-e28b0e489b91': 'fas fa-graduation-cap', // Unidade Curricular
                'd6175362-1a4a-4098-8d59-9bbbacc5a45e': 'fas fa-book', // Curso
                'default': 'fas fa-cube'
            };
            
            return iconMap[structureId] || iconMap.default;
        }

        function selectStructure(structureId) {
            console.log('üéØ Selecting structure:', structureId);
            
            // Update active state
            document.querySelectorAll('.structure-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeElement = document.querySelector(`[data-id="${structureId}"]`);
            if (activeElement) {
                activeElement.classList.add('active');
            }

            // Show structure dashboard
            showStructureDashboard(structureId);
        }

        function getStructureById(structureId) {
            if (!currentData || !currentData.data || !currentData.data.space || !currentData.data.space.structures) {
                return null;
            }
            
            // Get structures object and find the structure by ID
            const structures = currentData.data.space.structures;
            if (typeof structures === 'object' && structures[structureId]) {
                return {
                    id: structureId,
                    ...structures[structureId]
                };
            }
            
            return null;
        }

        async function showStructureDashboard(structureId) {
            console.log('üîç Looking for structure:', structureId);
            console.log('üìä Current data:', currentData);
            
            const structure = getStructureById(structureId);
            console.log('üéØ Found structure:', structure);
            
            if (!structure) {
                console.error('‚ùå Structure not found:', structureId);
                console.error('‚ùå Available structures:', Object.keys(currentData?.data?.space?.structures || {}));
                showError('Structure not found');
                return;
            }

            currentStructure = structureId;
            selectedProperties.clear();

            // Update UI
            document.getElementById('generalDashboard').classList.add('hidden');
            document.getElementById('structureDashboard').classList.add('active');
            
            const displayName = structure.title || structure.name || structureId;
            document.getElementById('structureTitle').textContent = displayName;
            document.getElementById('currentPage').textContent = displayName;

            // Load structure details with properties
            await loadStructureDetails(structureId);
        }

        function showWelcome() {
            document.getElementById('structureDashboard').classList.remove('active');
            document.getElementById('generalDashboard').classList.remove('hidden');
            document.getElementById('currentPage').textContent = 'Dashboard';
            
            // Clear structure data
            currentStructure = null;
            currentStructureData = null;
            selectedProperties.clear();
            
            // Hide statistics results
            document.getElementById('statisticsResults').style.display = 'none';
        }

        // Load detailed structure information with properties
        async function loadStructureDetails(structureId) {
            try {
                console.log(`üîç Loading structure details for: ${structureId}`);
                
                // Obter dados reais da estrutura
                const structureResponse = await fetch(`/api/dashboard/structure/${structureId}`);
                const structureData = await structureResponse.json();
                
                if (structureData.success && structureData.data) {
                    // Usar dados reais da API
                    currentStructureData = structureData.data;
                    console.log('üìã Structure details loaded (real):', structureData.data);
                    
                    // Update structure stats
                    updateStructureDetailStats(structureData.data);
                    
                    // Populate properties
                    populatePropertySelection(structureData.data.properties || []);
                    
                    // Populate relationships
                    populateRelationships(structureData.data.relationships || []);
                } else {
                    // Fallback para dados do dashboard geral
                    const dashboardResponse = await fetch('/api/dashboard');
                    const dashboardData = await dashboardResponse.json();
                    
                    if (dashboardData.success && dashboardData.data && dashboardData.data.space) {
                        const structure = dashboardData.data.space.structures[structureId];
                        
                        if (structure) {
                            const realStructureData = {
                                basic: {
                                    id: structureId,
                                    title: structure.name || structure.title || structureId,
                                    objectCount: structure.count || structure.objectCount || 0
                                },
                                properties: structure.propertyDefinitions || [],
                                propertyTypes: {},
                                relationships: [],
                                collections: []
                            };
                            
                            currentStructureData = realStructureData;
                            console.log('üìã Structure details loaded (from dashboard):', realStructureData);
                            
                            // Update structure stats
                            updateStructureDetailStats(realStructureData);
                            
                            // Populate properties
                            populatePropertySelection(realStructureData.properties || []);
                            
                            // Populate relationships
                            populateRelationships(realStructureData.relationships || []);
                        } else {
                            throw new Error('Structure not found in dashboard data');
                        }
                    } else {
                        throw new Error('Could not load structure details');
                    }
                }
            } catch (error) {
                console.error('Error loading structure details:', error);
                showError('Error loading structure details: ' + error.message);
            }
        }
        
        // Generate mock properties based on structure type
        async function getMockPropertiesForStructure(structureId) {
            // Tentar obter propriedades reais primeiro
            try {
                const structureResponse = await fetch(`/api/dashboard/structure/${structureId}`);
                const structureData = await structureResponse.json();
                
                if (structureData.success && structureData.data && structureData.data.properties) {
                    return structureData.data.properties;
                }
            } catch (error) {
                console.warn('Could not load real properties, using fallback:', error.message);
            }
            
            // Fallback para propriedades padr√£o
            const commonProperties = [
                { id: 'title', name: 'Title', type: 'text', description: 'The title of the item' },
                { id: 'description', name: 'Description', type: 'richText', description: 'Detailed description' },
                { id: 'createdAt', name: 'Created At', type: 'dateTime', description: 'When this item was created' },
                { id: 'updatedAt', name: 'Updated At', type: 'dateTime', description: 'When this item was last updated' }
            ];
            
            // Add specific properties based on structure type
            const specificProperties = {
                'RootPage': [
                    { id: 'content', name: 'Content', type: 'richText', description: 'Page content' },
                    { id: 'tags', name: 'Tags', type: 'multiSelect', description: 'Page tags' }
                ],
                'RootTag': [
                    { id: 'color', name: 'Color', type: 'select', description: 'Tag color' }
                ],
                'd2801ef5-bb7b-4ba0-8da7-b0f55453059d': [ // Pessoa
                    { id: 'name', name: 'Name', type: 'text', description: 'Person name' },
                    { id: 'email', name: 'Email', type: 'email', description: 'Email address' },
                    { id: 'phone', name: 'Phone', type: 'phone', description: 'Phone number' },
                    { id: 'birthDate', name: 'Birth Date', type: 'date', description: 'Date of birth' }
                ],
                '1fcab184-7c08-4b2e-8e6b-e28b0e489b91': [ // Unidade Curricular
                    { id: 'code', name: 'Code', type: 'text', description: 'Course code' },
                    { id: 'credits', name: 'Credits', type: 'number', description: 'Number of credits' },
                    { id: 'semester', name: 'Semester', type: 'select', description: 'Semester' }
                ],
                'd6175362-1a4a-4098-8d59-9bbbacc5a45e': [ // Curso
                    { id: 'duration', name: 'Duration', type: 'number', description: 'Course duration in months' },
                    { id: 'price', name: 'Price', type: 'currency', description: 'Course price' },
                    { id: 'category', name: 'Category', type: 'select', description: 'Course category' }
                ]
            };
            
            return [...commonProperties, ...(specificProperties[structureId] || [])];
        }

        function updateStructureDetailStats(structureData) {
            // Update statistics cards
            document.getElementById('totalProperties').textContent = structureData.properties?.length || 0;
            document.getElementById('totalRelationships').textContent = structureData.relationships?.length || 0;
            document.getElementById('totalCollections').textContent = structureData.collections?.length || 0;
            document.getElementById('selectedPropertiesCount').textContent = selectedProperties.size;
        }

        function populatePropertySelection(properties) {
            const container = document.getElementById('propertySelection');
            
            if (!properties || properties.length === 0) {
                container.innerHTML = '<div class="loading">No properties available for this structure</div>';
                return;
            }

            const propertiesHTML = properties.map(property => {
                const typeIcon = getPropertyTypeIcon(property.type);
                const typeClass = getPropertyTypeClass(property.type);
                const propertyName = property.name || property.id || 'Unknown Property';
                const propertyType = property.type?.toUpperCase() || 'UNKNOWN';
                const propertyDescription = property.description || 'No description available';
                
                return `
                    <div class="property-item" data-property-id="${property.id}" onclick="toggleProperty('${property.id}')">
                        <div class="property-checkbox">
                            <i class="fas fa-check" style="display: none;"></i>
                        </div>
                        <div class="property-icon">
                            <i class="${typeIcon}"></i>
                        </div>
                        <div class="property-info">
                            <div class="property-name">${propertyName}</div>
                            <div class="property-type ${typeClass}">${propertyType}</div>
                            <div class="property-description">${propertyDescription}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = propertiesHTML;
        }

        function populateRelationships(relationships) {
            const container = document.getElementById('relationshipsContainer');
            
            if (!relationships || relationships.length === 0) {
                container.innerHTML = '<div class="no-data">No relationships found with other structures</div>';
                return;
            }

            const relationshipsHTML = relationships.map(relationship => {
                const targetStructure = relationship.targetStructure || {};
                const targetName = targetStructure.title || targetStructure.name || 'Unknown Structure';
                const relationshipType = relationship.type || 'Unknown';
                const relationshipDirection = relationship.direction || 'Unknown';
                const relationshipDescription = relationship.description || '';
                
                return `
                    <div class="relationship-item">
                        <div class="relationship-header">
                            <i class="fas fa-link"></i>
                            <span class="relationship-title">${targetName}</span>
                        </div>
                        <div class="relationship-details">
                            <div class="relationship-type">${relationshipType}</div>
                            <div class="relationship-direction">${relationshipDirection}</div>
                            ${relationshipDescription ? `<div class="relationship-description">${relationshipDescription}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = relationshipsHTML;
        }

        function getPropertyTypeIcon(propertyType) {
            const iconMap = {
                'text': 'fas fa-font',
                'richText': 'fas fa-align-left',
                'number': 'fas fa-hashtag',
                'currency': 'fas fa-dollar-sign',
                'date': 'fas fa-calendar',
                'dateTime': 'fas fa-clock',
                'datetime': 'fas fa-clock',
                'select': 'fas fa-list',
                'multiSelect': 'fas fa-tasks',
                'email': 'fas fa-envelope',
                'phone': 'fas fa-phone',
                'url': 'fas fa-link',
                'entity': 'fas fa-cube',
                'entity_title': 'fas fa-heading',
                'entity_description': 'fas fa-align-left',
                'entity_createdAt': 'fas fa-calendar-plus',
                'entity_updatedAt': 'fas fa-calendar-check',
                'entity_tags': 'fas fa-tags',
                'blocks': 'fas fa-puzzle-piece',
                'object': 'fas fa-cube',
                'boolean': 'fas fa-toggle-on',
                'default': 'fas fa-cog'
            };
            
            return iconMap[propertyType] || iconMap.default;
        }

        function getPropertyTypeClass(propertyType) {
            const classMap = {
                'text': 'type-text',
                'richText': 'type-richtext',
                'number': 'type-number',
                'currency': 'type-currency',
                'date': 'type-date',
                'dateTime': 'type-datetime',
                'datetime': 'type-datetime',
                'select': 'type-select',
                'multiSelect': 'type-multiselect',
                'email': 'type-email',
                'phone': 'type-phone',
                'url': 'type-url',
                'entity': 'type-entity',
                'entity_title': 'type-entity',
                'entity_description': 'type-entity',
                'entity_createdAt': 'type-entity',
                'entity_updatedAt': 'type-entity',
                'entity_tags': 'type-entity',
                'blocks': 'type-blocks',
                'object': 'type-object',
                'boolean': 'type-boolean',
                'default': 'type-default'
            };
            
            return classMap[propertyType] || classMap.default;
        }

        function toggleProperty(propertyId) {
            const propertyItem = document.querySelector(`[data-property-id="${propertyId}"]`);
            const checkbox = propertyItem.querySelector('.property-checkbox i');
            
            if (selectedProperties.has(propertyId)) {
                selectedProperties.delete(propertyId);
                propertyItem.classList.remove('selected');
                checkbox.style.display = 'none';
            } else {
                selectedProperties.add(propertyId);
                propertyItem.classList.add('selected');
                checkbox.style.display = 'block';
            }
            
            // Update selected count
            document.getElementById('selectedPropertiesCount').textContent = selectedProperties.size;
            
            // Enable/disable generate button
            const generateBtn = document.getElementById('generateStatsBtn');
            generateBtn.disabled = selectedProperties.size === 0;
        }

        function selectAllProperties() {
            const properties = currentStructureData?.properties || [];
            properties.forEach(property => {
                if (!selectedProperties.has(property.id)) {
                    selectedProperties.add(property.id);
                    const propertyItem = document.querySelector(`[data-property-id="${property.id}"]`);
                    const checkbox = propertyItem.querySelector('.property-checkbox i');
                    propertyItem.classList.add('selected');
                    checkbox.style.display = 'block';
                }
            });
            
            document.getElementById('selectedPropertiesCount').textContent = selectedProperties.size;
            document.getElementById('generateStatsBtn').disabled = selectedProperties.size === 0;
        }

        function clearAllProperties() {
            selectedProperties.forEach(propertyId => {
                const propertyItem = document.querySelector(`[data-property-id="${propertyId}"]`);
                const checkbox = propertyItem.querySelector('.property-checkbox i');
                propertyItem.classList.remove('selected');
                checkbox.style.display = 'none';
            });
            
            selectedProperties.clear();
            document.getElementById('selectedPropertiesCount').textContent = 0;
            document.getElementById('generateStatsBtn').disabled = true;
            
            // Hide statistics results
            document.getElementById('statisticsResults').style.display = 'none';
        }

        async function generateStatistics() {
            if (selectedProperties.size === 0) {
                showError('Please select at least one property');
                return;
            }

            try {
                console.log(`üìä Generating statistics for properties:`, Array.from(selectedProperties));
                
                // Tentar gerar estat√≠sticas reais primeiro
                try {
                    const response = await fetch(`/api/dashboard/structure/${currentStructure}/statistics`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            selectedProperties: Array.from(selectedProperties)
                        })
                    });
                    
                    const statisticsData = await response.json();
                    
                    if (statisticsData.success) {
                        console.log('üìà Statistics generated (real):', statisticsData.data);
                        displayStatisticsResults(statisticsData.data);
                        return;
                    }
                } catch (error) {
                    console.warn('Could not generate real statistics, using mock data:', error.message);
                }
                
                // Fallback para estat√≠sticas simuladas
                const mockStatistics = await generateMockStatistics(Array.from(selectedProperties));
                
                console.log('üìà Statistics generated (mock):', mockStatistics);
                displayStatisticsResults(mockStatistics);
                
            } catch (error) {
                console.error('Error generating statistics:', error);
                showError('Error generating statistics: ' + error.message);
            }
        }
        
        async function generateMockStatistics(selectedPropertyIds) {
            const selectedPropertiesDetails = currentStructureData.properties.filter(p => 
                selectedPropertyIds.includes(p.id)
            );
            
            const statistics = {
                structureInfo: {
                    id: currentStructure,
                    title: currentStructureData.basic.title,
                    pluralName: currentStructureData.basic.title + 's',
                    labelColor: 'blue'
                },
                selectedProperties: selectedPropertiesDetails,
                propertyStatistics: {},
                relationships: [],
                mockData: true, // Marcar como dados simulados
                realData: false
            };
            
            // Generate statistics for each selected property
            selectedPropertiesDetails.forEach(property => {
                switch (property.type) {
                    case 'text':
                    case 'richText':
                        statistics.propertyStatistics[property.id] = {
                            type: 'text',
                            totalEntries: Math.floor(Math.random() * 100) + 10,
                            averageLength: Math.floor(Math.random() * 200) + 50,
                            emptyEntries: Math.floor(Math.random() * 20),
                            wordCloud: [
                                { word: 'analytics', frequency: Math.floor(Math.random() * 50) + 5 },
                                { word: 'dashboard', frequency: Math.floor(Math.random() * 40) + 5 },
                                { word: 'data', frequency: Math.floor(Math.random() * 60) + 5 }
                            ]
                        };
                        break;

                    case 'number':
                    case 'currency':
                        statistics.propertyStatistics[property.id] = {
                            type: 'numeric',
                            totalEntries: Math.floor(Math.random() * 100) + 10,
                            min: Math.floor(Math.random() * 100),
                            max: Math.floor(Math.random() * 900) + 100,
                            average: Math.floor(Math.random() * 500) + 100,
                            median: Math.floor(Math.random() * 400) + 150,
                            distribution: Array.from({ length: 10 }, (_, i) => ({
                                range: `${i * 10}-${(i + 1) * 10}`,
                                count: Math.floor(Math.random() * 20) + 1
                            }))
                        };
                        break;

                    case 'date':
                    case 'dateTime':
                        statistics.propertyStatistics[property.id] = {
                            type: 'temporal',
                            totalEntries: Math.floor(Math.random() * 100) + 10,
                            earliestDate: '2023-01-01',
                            latestDate: '2024-12-31',
                            timelineData: Array.from({ length: 12 }, (_, i) => ({
                                month: `2024-${String(i + 1).padStart(2, '0')}`,
                                count: Math.floor(Math.random() * 30) + 1
                            })),
                            yearDistribution: [
                                { year: '2022', count: Math.floor(Math.random() * 20) + 5 },
                                { year: '2023', count: Math.floor(Math.random() * 40) + 10 },
                                { year: '2024', count: Math.floor(Math.random() * 60) + 15 }
                            ]
                        };
                        break;

                    case 'select':
                    case 'multiSelect':
                        const options = ['Option A', 'Option B', 'Option C', 'Option D'];
                        statistics.propertyStatistics[property.id] = {
                            type: 'categorical',
                            totalEntries: Math.floor(Math.random() * 100) + 10,
                            uniqueValues: Math.floor(Math.random() * 10) + 3,
                            distribution: options.map(option => ({
                                value: option,
                                count: Math.floor(Math.random() * 30) + 1
                            })),
                            topValues: [
                                { value: 'Most common', count: Math.floor(Math.random() * 50) + 20 },
                                { value: 'Second most', count: Math.floor(Math.random() * 40) + 15 },
                                { value: 'Third most', count: Math.floor(Math.random() * 30) + 10 }
                            ]
                        };
                        break;

                    default:
                        statistics.propertyStatistics[property.id] = {
                            type: 'unknown',
                            totalEntries: Math.floor(Math.random() * 50) + 5,
                            message: `Statistics for ${property.type} properties`
                        };
                }
            });
            
            return statistics;
        }

        function displayStatisticsResults(statisticsData) {
            const resultsContainer = document.getElementById('statisticsResults');
            const chartsContainer = document.getElementById('statisticsCharts');
            
            // Clear previous results
            chartsContainer.innerHTML = '';
            
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Generate charts for each selected property
            if (statisticsData.selectedProperties && Array.isArray(statisticsData.selectedProperties)) {
                statisticsData.selectedProperties.forEach(property => {
                    const propertyStats = statisticsData.propertyStatistics?.[property.id];
                    if (propertyStats) {
                        const chartCard = createStatisticsChart(property, propertyStats);
                        chartsContainer.appendChild(chartCard);
                    }
                });
            }
            
            // Show mock data indicator if applicable
            if (statisticsData.mockData) {
                const mockIndicator = document.createElement('div');
                mockIndicator.style.cssText = 'background: #fef3c7; color: #92400e; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 14px;';
                mockIndicator.innerHTML = '<i class="fas fa-info-circle"></i> Note: These are simulated statistics for demonstration purposes';
                resultsContainer.insertBefore(mockIndicator, chartsContainer);
            } else if (statisticsData.realData) {
                const realIndicator = document.createElement('div');
                realIndicator.style.cssText = 'background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 14px;';
                realIndicator.innerHTML = '<i class="fas fa-check-circle"></i> These are real statistics from your data';
                resultsContainer.insertBefore(realIndicator, chartsContainer);
            }
        }

        function createStatisticsChart(property, stats) {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-title">
                    <i class="${getPropertyTypeIcon(property.type)}"></i>
                    ${property.name} (${property.type?.toUpperCase() || 'UNKNOWN'})
                </div>
                <div class="chart-container">
                    <canvas id="chart-${property.id}"></canvas>
                </div>
            `;
            
            // Create chart after element is added to DOM
            setTimeout(() => {
                createPropertyChart(property.id, property, stats);
            }, 100);
            
            return chartCard;
        }

        function createPropertyChart(propertyId, property, stats) {
            const canvas = document.getElementById(`chart-${propertyId}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const chartType = getChartTypeForProperty(property.type, stats);
            
            try {
                new Chart(ctx, {
                    type: chartType,
                    data: getChartData(property, stats, chartType),
                    options: getChartOptions(chartType, property.name)
                });
            } catch (error) {
                console.error(`Error creating chart for property ${propertyId}:`, error);
                // Show error message in chart container
                canvas.parentElement.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Error creating chart</div>
                        <div style="font-size: 12px;">${error.message}</div>
                    </div>
                `;
            }
        }

        function getChartTypeForProperty(propertyType, stats) {
            if (stats.type === 'numeric' || propertyType === 'number' || propertyType === 'currency') {
                return 'bar';
            } else if (stats.type === 'temporal' || propertyType === 'date' || propertyType === 'dateTime') {
                return 'line';
            } else if (stats.type === 'categorical' || propertyType === 'select' || propertyType === 'multiSelect') {
                return 'doughnut';
            } else {
                return 'bar';
            }
        }

        function getChartData(property, stats, chartType) {
            switch (chartType) {
                case 'bar':
                    if (stats.distribution) {
                        return {
                            labels: stats.distribution.map(d => d.range || d.value),
                            datasets: [{
                                label: property.name,
                                data: stats.distribution.map(d => d.count),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        };
                    } else {
                        return {
                            labels: ['Data'],
                            datasets: [{
                                label: property.name,
                                data: [stats.totalEntries || 0],
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        };
                    }
                    
                case 'line':
                    if (stats.timelineData) {
                        return {
                            labels: stats.timelineData.map(d => d.month),
                            datasets: [{
                                label: property.name,
                                data: stats.timelineData.map(d => d.count),
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        };
                    } else {
                        return {
                            labels: ['Data'],
                            datasets: [{
                                label: property.name,
                                data: [stats.totalEntries || 0],
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        };
                    }
                    
                case 'doughnut':
                    if (stats.distribution) {
                        return {
                            labels: stats.distribution.map(d => d.value),
                            datasets: [{
                                data: stats.distribution.map(d => d.count),
                                backgroundColor: [
                                    '#3B82F6', '#8B5CF6', '#EC4899', '#10B981', '#F59E0B',
                                    '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        };
                    } else {
                        return {
                            labels: ['Data'],
                            datasets: [{
                                data: [stats.totalEntries || 0],
                                backgroundColor: ['#3B82F6'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        };
                    }
                    
                default:
                    return {
                        labels: ['Data'],
                        datasets: [{
                            label: property.name,
                            data: [stats.totalEntries || 0],
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    };
            }
        }

        function getChartOptions(chartType, propertyName) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: chartType === 'doughnut',
                        position: 'bottom'
                    }
                }
            };
            
            if (chartType === 'bar' || chartType === 'line') {
                baseOptions.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                };
            }
            
            return baseOptions;
        }

        async function updateStructureStats(structureId) {
            try {
                const response = await fetch(`/api/dashboard/structure/${structureId}/`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalObjects').textContent = stats.totalObjects || 0;
                    document.getElementById('totalProperties').textContent = stats.totalProperties || 0;
                    document.getElementById('totalReferences').textContent = stats.totalReferences || 0;
                    document.getElementById('lastUpdated').textContent = 'Agora';
                }
            } catch (error) {
                console.error('Error updating structure stats:', error);
                // Set default values
                document.getElementById('totalObjects').textContent = 'N/A';
                document.getElementById('totalProperties').textContent = 'N/A';
                document.getElementById('totalReferences').textContent = 'N/A';
                document.getElementById('lastUpdated').textContent = 'N/A';
            }
        }

        function createGeneralCharts(structures) {
            console.log('üìä Creating general charts with structures:', structures);
            
            // Create structures distribution chart
            createStructuresDistributionChart(structures);
            
            // Create top structures chart
            createTopStructuresChart(structures);
        }

        function createStructuresDistributionChart(structures) {
            const ctx = document.getElementById('structuresChart');
            if (!ctx) return;
            
            const structuresArray = Object.values(structures);
            const labels = structuresArray.map(s => s.name || s.title || s.id);
            const data = structuresArray.map(s => s.count || s.objectCount || 0);
            const colors = generateChartColors(data.length);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createTopStructuresChart(structures) {
            const ctx = document.getElementById('topStructuresChart');
            if (!ctx) return;
            
            const structuresArray = Object.values(structures)
                .sort((a, b) => (b.count || b.objectCount || 0) - (a.count || a.objectCount || 0))
                .slice(0, 10);
            
            const labels = structuresArray.map(s => s.name || s.title || s.id);
            const data = structuresArray.map(s => s.count || s.objectCount || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Objects',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function generateChartColors(count) {
            const colors = [
                '#3B82F6', '#8B5CF6', '#EC4899', '#10B981', '#F59E0B',
                '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        async function refreshData() {
            try {
                console.log('üîÑ Refreshing data...');
                
                // Show loading state
                const refreshBtn = document.querySelector('.refresh-btn');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                refreshBtn.disabled = true;
                
                // Reload structures
                await loadStructures();
                
                // If we're on a structure dashboard, reload its details
                if (currentStructure) {
                    await loadStructureDetails(currentStructure);
                }
                
                // Reset button
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
                console.log('‚úÖ Data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Error refreshing data: ' + error.message);
                
                // Reset button even on error
                const refreshBtn = document.querySelector('.refresh-btn');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.disabled = false;
            }
        }

        function showError(message) {
            console.error('‚ùå Error:', message);
            
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--error-color);
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 14px;
            `;
            errorDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // App will be initialized when DOM is loaded

        // ===== FUN√á√ïES PARA DIAGRAMA DE RELACIONAMENTOS =====
        
        async function loadRelationshipDiagram() {
            if (!currentStructure) {
                showError('Please select a structure first');
                return;
            }

            try {
                const response = await fetch(`/api/dashboard/structure/${currentStructure}/relationship-diagram`);
                const data = await response.json();
                
                if (data.success) {
                    renderRelationshipDiagram(data.data);
                } else {
                    showError('Error loading relationship diagram: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading relationship diagram:', error);
                showError('Error loading relationship diagram: ' + error.message);
            }
        }

        function renderRelationshipDiagram(diagramData) {
            const container = document.getElementById('relationshipDiagram');
            container.innerHTML = '';
            
            // Create SVG container
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '600');
            svg.style.position = 'relative';
            
            // Add arrow marker definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#3b82f6');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            // Render main structure
            renderStructureBox(svg, diagramData.mainStructure, true);
            
            // Render related structures
            diagramData.relatedStructures.forEach(structure => {
                renderStructureBox(svg, structure, false);
            });
            
            // Render relationships
            diagramData.relationships.forEach(relationship => {
                renderRelationship(svg, relationship, diagramData);
            });
            
            container.appendChild(svg);
        }

        function renderStructureBox(svg, structure, isMain) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('transform', `translate(${structure.position.x}, ${structure.position.y})`);
            
            // Create structure box
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', '200');
            rect.setAttribute('height', '120');
            rect.setAttribute('rx', '8');
            rect.setAttribute('fill', isMain ? '#f8fafc' : '#ffffff');
            rect.setAttribute('stroke', isMain ? '#3b82f6' : '#e2e8f0');
            rect.setAttribute('stroke-width', isMain ? '3' : '2');
            
            group.appendChild(rect);
            
            // Create header
            const headerGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            headerGroup.setAttribute('transform', 'translate(10, 15)');
            
            const headerRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            headerRect.setAttribute('width', '180');
            headerRect.setAttribute('height', '25');
            headerRect.setAttribute('rx', '4');
            headerRect.setAttribute('fill', structure.color || '#3b82f6');
            
            const headerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            headerText.setAttribute('x', '90');
            headerText.setAttribute('y', '17');
            headerText.setAttribute('text-anchor', 'middle');
            headerText.setAttribute('fill', 'white');
            headerText.setAttribute('font-size', '12');
            headerText.setAttribute('font-weight', 'bold');
            headerText.textContent = structure.name;
            
            headerGroup.appendChild(headerRect);
            headerGroup.appendChild(headerText);
            group.appendChild(headerGroup);
            
            // Create properties
            structure.properties.slice(0, 5).forEach((prop, index) => {
                const propGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                propGroup.setAttribute('transform', `translate(10, ${45 + index * 12})`);
                
                const propText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                propText.setAttribute('x', '0');
                propText.setAttribute('y', '0');
                propText.setAttribute('fill', prop.primaryKey ? '#3b82f6' : prop.foreignKey ? '#f59e0b' : '#64748b');
                propText.setAttribute('font-size', '10');
                propText.setAttribute('font-weight', prop.primaryKey ? 'bold' : 'normal');
                
                let propSymbol = '';
                if (prop.primaryKey) propSymbol = 'üîë ';
                else if (prop.foreignKey) propSymbol = 'üîó ';
                else propSymbol = '‚Ä¢ ';
                
                propText.textContent = propSymbol + prop.name;
                
                propGroup.appendChild(propText);
                group.appendChild(propGroup);
            });
            
            // Add more properties indicator if needed
            if (structure.properties.length > 5) {
                const moreGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                moreGroup.setAttribute('transform', `translate(10, ${45 + 5 * 12})`);
                
                const moreText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                moreText.setAttribute('x', '0');
                moreText.setAttribute('y', '0');
                moreText.setAttribute('fill', '#94a3b8');
                moreText.setAttribute('font-size', '10');
                moreText.setAttribute('font-style', 'italic');
                moreText.textContent = `... +${structure.properties.length - 5} more`;
                
                moreGroup.appendChild(moreText);
                group.appendChild(moreGroup);
            }
            
            svg.appendChild(group);
        }

        function renderRelationship(svg, relationship, diagramData) {
            const fromStructure = relationship.from === diagramData.mainStructure.id ? 
                diagramData.mainStructure : 
                diagramData.relatedStructures.find(s => s.id === relationship.from);
            
            const toStructure = relationship.to === diagramData.mainStructure.id ? 
                diagramData.mainStructure : 
                diagramData.relatedStructures.find(s => s.id === relationship.to);
            
            if (!fromStructure || !toStructure) return;
            
            // Calculate line coordinates
            const fromX = fromStructure.position.x + 100;
            const fromY = fromStructure.position.y + 60;
            const toX = toStructure.position.x + 100;
            const toY = toStructure.position.y + 60;
            
            // Create relationship line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', fromX);
            line.setAttribute('y1', fromY);
            line.setAttribute('x2', toX);
            line.setAttribute('y2', toY);
            line.setAttribute('stroke', '#3b82f6');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            
            svg.appendChild(line);
            
            // Create relationship label
            const labelGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const midX = (fromX + toX) / 2;
            const midY = (fromY + toY) / 2;
            
            const labelRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            labelRect.setAttribute('x', midX - 30);
            labelRect.setAttribute('y', midY - 10);
            labelRect.setAttribute('width', '60');
            labelRect.setAttribute('height', '20');
            labelRect.setAttribute('rx', '10');
            labelRect.setAttribute('fill', '#f8fafc');
            labelRect.setAttribute('stroke', '#3b82f6');
            labelRect.setAttribute('stroke-width', '1');
            
            const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelText.setAttribute('x', midX);
            labelText.setAttribute('y', midY + 5);
            labelText.setAttribute('text-anchor', 'middle');
            labelText.setAttribute('fill', '#3b82f6');
            labelText.setAttribute('font-size', '10');
            labelText.setAttribute('font-weight', 'bold');
            labelText.textContent = relationship.label || relationship.type;
            
            labelGroup.appendChild(labelRect);
            labelGroup.appendChild(labelText);
            svg.appendChild(labelGroup);
        }

        // ===== FUN√á√ïES PARA ESTAT√çSTICAS CUSTOMIZADAS =====
        
        function populateCustomStatsBuilder(properties) {
            const xAxisSelect = document.getElementById('xAxisSelect');
            const yAxisSelect = document.getElementById('yAxisSelect');
            
            // Clear existing options
            xAxisSelect.innerHTML = '<option value="">Select Property</option>';
            yAxisSelect.innerHTML = '<option value="">Select Property</option>';
            
            // Populate with available properties
            properties.forEach(prop => {
                const xOption = document.createElement('option');
                xOption.value = prop.id;
                xOption.textContent = `${prop.name} (${prop.type})`;
                xAxisSelect.appendChild(xOption);
                
                const yOption = document.createElement('option');
                yOption.value = prop.id;
                yOption.textContent = `${prop.name} (${prop.type})`;
                yAxisSelect.appendChild(yOption);
            });
            
            // Update Y-axis visibility based on chart type
            updateYAxisVisibility();
        }

        function updateYAxisVisibility() {
            const chartType = document.getElementById('chartTypeSelect').value;
            const yAxisField = document.getElementById('yAxisField');
            const yAxisSelect = document.getElementById('yAxisSelect');
            
            if (chartType === 'single-value' || chartType === 'progress') {
                yAxisField.style.display = 'none';
                yAxisSelect.required = false;
            } else {
                yAxisField.style.display = 'block';
                yAxisSelect.required = true;
            }
        }

        // Add event listener for chart type changes
        document.addEventListener('DOMContentLoaded', function() {
            const chartTypeSelect = document.getElementById('chartTypeSelect');
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', updateYAxisVisibility);
            }
        });

        async function generateCustomChart() {
            if (!currentStructure) {
                showError('Please select a structure first');
                return;
            }

            const chartType = document.getElementById('chartTypeSelect').value;
            const xAxis = document.getElementById('xAxisSelect').value;
            const yAxis = document.getElementById('yAxisSelect').value;
            const aggregation = document.getElementById('aggregationSelect').value;

            if (!xAxis) {
                showError('Please select an X-axis property');
                return;
            }

            if (chartType !== 'single-value' && chartType !== 'progress' && !yAxis) {
                showError('Please select a Y-axis property for this chart type');
                return;
            }

            try {
                const response = await fetch(`/api/dashboard/structure/${currentStructure}/custom-chart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chartType,
                        xAxis,
                        yAxis,
                        aggregation
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    renderCustomChart(data.data);
                } else {
                    showError('Error generating chart: ' + data.error);
                }
            } catch (error) {
                console.error('Error generating custom chart:', error);
                showError('Error generating custom chart: ' + error.message);
            }
        }

        function renderCustomChart(chartData) {
            const container = document.getElementById('customChartResult');
            container.style.display = 'block';
            container.innerHTML = '';

            switch (chartData.chartType) {
                case 'single-value':
                    renderSingleValueCard(container, chartData.data);
                    break;
                case 'progress':
                    renderProgressCard(container, chartData.data);
                    break;
                case 'bar':
                case 'line':
                case 'scatter':
                    renderXYChart(container, chartData.data, chartData.chartType);
                    break;
                case 'pie':
                case 'doughnut':
                    renderCategoricalChart(container, chartData.data, chartData.chartType);
                    break;
                default:
                    container.innerHTML = '<div class="error">Unsupported chart type</div>';
            }
        }

        function renderSingleValueCard(container, data) {
            const card = document.createElement('div');
            card.className = 'single-value-card';
            card.innerHTML = `
                <div class="single-value-number">
                    ${data.value}${data.unit ? ' ' + data.unit : ''}
                </div>
                <div class="single-value-label">${data.label}</div>
                <div class="single-value-change ${data.change === '+' ? 'change-positive' : 'change-negative'}">
                    ${data.change}${data.changeValue} ${data.changeLabel}
                </div>
            `;
            container.appendChild(card);
        }

        function renderProgressCard(container, data) {
            const card = document.createElement('div');
            card.className = 'progress-card';
            card.innerHTML = `
                <div class="progress-header">
                    <div class="progress-label">${data.label}</div>
                    <div class="progress-values">
                        ${data.current}${data.unit ? ' ' + data.unit : ''} / ${data.total}${data.unit ? ' ' + data.unit : ''}
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar progress-${data.status}" style="width: ${data.percentage}%">
                        ${data.percentage}%
                    </div>
                </div>
                <div class="progress-percentage">${data.percentage}%</div>
            `;
            container.appendChild(card);
        }

        function renderXYChart(container, data, chartType) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '400px';
            
            const canvas = document.createElement('canvas');
            canvas.id = 'custom-chart-canvas';
            chartContainer.appendChild(canvas);
            container.appendChild(chartContainer);
            
            // Create chart using Chart.js
            setTimeout(() => {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: chartType,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${data.yAxisLabel} by ${data.xAxisLabel}`
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: data.xAxisLabel
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: data.yAxisLabel
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        function renderCategoricalChart(container, data, chartType) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '400px';
            
            const canvas = document.createElement('canvas');
            canvas.id = 'custom-chart-canvas';
            chartContainer.appendChild(canvas);
            container.appendChild(chartContainer);
            
            // Create chart using Chart.js
            setTimeout(() => {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: chartType,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: data.propertyName
                            }
                        }
                    }
                });
            }, 100);
        }
    </script>
</body>
</html>






